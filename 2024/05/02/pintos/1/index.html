<!DOCTYPE html><html class="hide-aside" lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>OS Project 1 WIL | Malgcheong's Blog</title><meta name="author" content="Cheongwoo Nam"><meta name="copyright" content="Cheongwoo Nam"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. Alarm Clocktimer interrupt timer는 하드웨어를 통해 초당 PIT_FREQ 회 interrupt가 발생함. 4tic마다 time slicing하여 멀티 태스킹을 할 스레드들이 골고루 cpu 연산 작업을 하기 위해 timer interrupt를 사용함. interrupt는 지금 실행중인 thread를 잠깐 멈추고 그 interru">
<meta property="og:type" content="article">
<meta property="og:title" content="OS Project 1 WIL">
<meta property="og:url" content="https://malgcheong.github.io/2024/05/02/pintos/1/index.html">
<meta property="og:site_name" content="Malgcheong&#39;s Blog">
<meta property="og:description" content="1. Alarm Clocktimer interrupt timer는 하드웨어를 통해 초당 PIT_FREQ 회 interrupt가 발생함. 4tic마다 time slicing하여 멀티 태스킹을 할 스레드들이 골고루 cpu 연산 작업을 하기 위해 timer interrupt를 사용함. interrupt는 지금 실행중인 thread를 잠깐 멈추고 그 interru">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://malgcheong.github.io/images/pintos/part1%20thread.jpg">
<meta property="article:published_time" content="2024-05-01T15:00:00.000Z">
<meta property="article:modified_time" content="2024-08-09T04:49:27.100Z">
<meta property="article:author" content="Cheongwoo Nam">
<meta property="article:tag" content="SW 사관학교 정글">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://malgcheong.github.io/images/pintos/part1%20thread.jpg"><link rel="shortcut icon" href="/images/common/favicon.jpg"><link rel="canonical" href="https://malgcheong.github.io/2024/05/02/pintos/1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@600&amp;family=Poetsen+One&amp;family=Radio+Canada+Big&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OS Project 1 WIL',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-09 13:49:27'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/common/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://malgcheong.notion.site"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/pintos/part1%20thread.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Malgcheong's Blog"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://malgcheong.notion.site"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">OS Project 1 WIL<a class="post-edit-link" href="https://github.com/malgcheong/malgcheong.github.io/edit/main/source/_posts/pintos/1.md" title="Edited on" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-05-01T15:00:00.000Z" title="Created 2024-05-02 00:00:00">2024-05-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-09T04:49:27.100Z" title="Updated 2024-08-09 13:49:27">2024-08-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PINTOS/">PINTOS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="OS Project 1 WIL"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-Alarm-Clock"><a href="#1-Alarm-Clock" class="headerlink" title="1. Alarm Clock"></a>1. Alarm Clock</h1><h3 id="timer-interrupt"><a href="#timer-interrupt" class="headerlink" title="timer interrupt"></a>timer interrupt</h3><ol>
<li>timer는 하드웨어를 통해 초당 PIT_FREQ 회 interrupt가 발생함.</li>
<li>4tic마다 time slicing하여 멀티 태스킹을 할 스레드들이 골고루 cpu 연산 작업을 하기 위해 timer interrupt를 사용함.</li>
<li>interrupt는 지금 실행중인 thread를 잠깐 멈추고 그 interrupt에 해당하는 핸들러를 수행하도록 함. interrupt 핸들러가 수행되면 기존에 작업하던 스레드로 돌아감.</li>
</ol>
<h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><ol>
<li>pintos는 busy waitng 방식으로, ready queue에서 깨어날지 안할지를 thread_yield ()를 매번 발생시켜 cpu에서 확인함. cpu에서 확인하기 때문에 그만큼 쓸데없는 자원을 많이 소모함.</li>
</ol>
<h3 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h3><ol>
<li>sleep list를 만들어 thread가 wait해야할 시간동안 sleep list에 저장했다가 ready queue로 옮기도록 구현함.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 스레드를 sleep 시켜서 sleep_list에 넣습니다.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_sleep</span><span class="params">(<span class="type">int64_t</span> ticks)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">intr_level</span> <span class="title">old_level</span>;</span></span><br><span class="line"></span><br><span class="line">    old_level = intr_disable();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (curr != idle_thread) &#123;</span><br><span class="line">        curr-&gt;wakeup_ticks = ticks;</span><br><span class="line">        list_push_front(&amp;sleep_list, &amp;curr-&gt;elem);</span><br><span class="line">        next_awake_ticks(curr-&gt;wakeup_ticks);</span><br><span class="line">        thread_block();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    intr_set_level(old_level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>thread 구조체에 자신의 thread가 일어날 시간인 wakeup_ticks를 설정함. thread가 일어날 단위가 tick이라서 timer interrupt 핸들러에서 sleep list를 확인하고 wakeup_ticks을 통해 wake up할 스레드를 찾으면 sleep list에서 삭제하고 ready queue에 추가함.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 일어날 시간이 되면 대기 큐에 업데이트 후 sleep_list에서 remove</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_wakeup</span><span class="params">(<span class="type">int64_t</span> ticks)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_elem</span> *<span class="title">e</span> =</span> list_begin(&amp;sleep_list);  <span class="comment">// sleep_list 시작부터 순회</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ticks &lt; next_tick_to_awake)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != list_end(&amp;sleep_list))  <span class="comment">// sleep_list에 마지막까지 봄</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span> =</span> list_entry(e, <span class="keyword">struct</span> thread, elem);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;wakeup_ticks &lt;= ticks) &#123;</span><br><span class="line">            e = list_remove(e);</span><br><span class="line">                threaunblock(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            e = list_next(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>sleep list 조회의 효율성을 위해 가장 빨리 깨어날 thread의 시간을 전역변수로 설정함. 왜냐하면 지금 os의 tick이 sleep list에서 가장 빨리 일어나야할 thread보다 작다면 sleep list를 조회할 필요 없다. 깨울 thread가 있는 경우에만 sleep list를 조회했다.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int64_t</span> next_tick_to_awake = <span class="literal">NULL</span>; <span class="comment">// 전역변수로 선언</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 일어날 시간이 되면 대기 큐에 업데이트 후 sleep_list에서 remove</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_wakeup</span><span class="params">(<span class="type">int64_t</span> ticks)</span> &#123;</span><br><span class="line">        ... </span><br><span class="line">    <span class="keyword">if</span> (ticks &lt; next_tick_to_awake)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="2-Priority-Scheduling"><a href="#2-Priority-Scheduling" class="headerlink" title="2. Priority Scheduling"></a>2. Priority Scheduling</h1><h3 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem"></a>Problem</h3><ol>
<li>기존에 구현되어 있던 것은 round-robin 방식임.</li>
<li>파일을 다운하면서 게임을 하듯이 우선순위가 높은 게임이 먼저 실행되기 위해서 thread마다 우선순위를 부여해 스케줄링할 필요가 있음.</li>
</ol>
<h3 id="Solve-1"><a href="#Solve-1" class="headerlink" title="Solve"></a>Solve</h3><ol>
<li>ready queue에  priority를 내림차순으로 정렬해 우선순위가 높은 thread를 CPU에 thread_yield ()될 수 있도록 구현함.    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* CPU를 양보합니다. 현재 스레드는 슬립 상태로 전환되지 않으며,</span></span><br><span class="line"><span class="comment">    스케줄러의 변덕에 따라 즉시 다시 스케줄될 수 있습니다. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_yield</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">intr_level</span> <span class="title">old_level</span>;</span></span><br><span class="line"></span><br><span class="line">    ASSERT(!intr_context());</span><br><span class="line">    </span><br><span class="line">    old_level = intr_disable();</span><br><span class="line">    <span class="keyword">if</span> (curr != idle_thread) &#123;</span><br><span class="line">        <span class="comment">// list_push_back(&amp;ready_list, &amp;curr-&gt;elem);</span></span><br><span class="line">        list_insert_desc_ordered(&amp;ready_list, &amp;curr-&gt;elem, compare_priority, PRIORITY);</span><br><span class="line">    &#125;</span><br><span class="line">    do_schedule(THREAD_READY);</span><br><span class="line">    intr_set_level(old_level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 값 비교. t1의 우선순위가 낮은 경우 true*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">compare_priority</span><span class="params">(<span class="keyword">struct</span> list_elem *e1, <span class="keyword">struct</span> list_elem *e2, <span class="type">void</span> *aux)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t1</span> =</span> list_entry(e1, <span class="keyword">struct</span> thread, elem);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t2</span> =</span> list_entry(e2, <span class="keyword">struct</span> thread, elem);</span><br><span class="line">    <span class="type">int</span> t1_priority = t1-&gt;priority;</span><br><span class="line">    <span class="type">int</span> t2_priority = t2-&gt;priority;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// list_insert_desc_ordered에서 e1, e2 순서 반대여서 첫번째 요소가 작을 경우가 참임</span></span><br><span class="line">    <span class="keyword">if</span> (t1_priority &lt; t2_priority) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>thread가 생성 될 때와 cpu의 priority가 변경 될 때 ready queue의 첫 thread의 priority와 cpu에 올라간 thread의 priority를 비교해 thread_yield () 할 수 있도록 구현함. 높은 우선순위의 스레드가 생기자마자 해당 스레드를 cpu에서 사용하기 위해서임.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">tid_t</span> <span class="title function_">thread_create</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> priority, thread_func *function, <span class="type">void</span> *aux)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    <span class="comment">/* 준비 큐에 추가. */</span></span><br><span class="line">    thread_unblock(t);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 우선순위 스케줄링</span></span><br><span class="line">    test_max_priority();</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 현재 스레드의 우선순위를 NEW_PRIORITY로 설정합니다. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_set_priority</span><span class="params">(<span class="type">int</span> new_priority)</span> &#123;</span><br><span class="line">    thread_current()-&gt;priority = new_priority;</span><br><span class="line">    test_max_priority();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 우선순위 스케줄링 하는 함수</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">test_max_priority</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_elem</span> *<span class="title">highest_elem</span> =</span> list_begin(&amp;ready_list);</span><br><span class="line">    <span class="keyword">if</span> (list_end(&amp;ready_list) == (highest_elem)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (compare_priority(&amp;curr-&gt;elem, highest_elem, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        thread_yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="3-Priority-Scheduling-priority-inversion"><a href="#3-Priority-Scheduling-priority-inversion" class="headerlink" title="3. Priority Scheduling - priority inversion"></a>3. Priority Scheduling - priority inversion</h1><h3 id="Problem-2"><a href="#Problem-2" class="headerlink" title="Problem"></a>Problem</h3><ol>
<li>낮은 우선순위의 thread가 공유자원에 lock을 건 채로 cpu에서 연산작업을 하다가<br>높은 우선순위의 thread가 생성되면 thread_yield ()가 발생해 context switching이 발생한다.<br>높은 우선순위의 thread가 cpu에 올라가 동일한 공유자원에 lock을 얻고 싶어도 cpu를 반환하게 되고<br>우선순위가 낮은 thread가 먼저 실행되는 우선순위 역전의 문제가 발생한다.</li>
<li>혹은 낮은 우선순위의 thread가 lock을 쥔채로 대기 상태로 들어가고<br>해당 lock을 갖고 싶은 높은 우선순위의 thread가 계속 cpu를 선점한다면 dead lock이 발생한다.</li>
</ol>
<h3 id="Solve-donation"><a href="#Solve-donation" class="headerlink" title="Solve (donation)"></a>Solve (donation)</h3><ol>
<li>위의 문제를 해결하기 위해선  priority donation이 필요하다.</li>
<li>lock 잠금시 이미 lock을 소유한 thread에게 높은 우선순위의 thread의 priority를 상속한다.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">donate_priority</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> depth;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (depth = <span class="number">0</span>; depth &lt; <span class="number">8</span> ; depth++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!curr-&gt;wait_on_lock) </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">holder</span> =</span> curr-&gt;wait_on_lock-&gt;holder;</span><br><span class="line">        holder-&gt;priority = curr-&gt;priority;</span><br><span class="line">        curr = holder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>lock 해제시 priority를 반환한다. 하지만 그 lock을 원하는 우선순위의 thread로 바뀌거나 없다면 자기 자신의 priority로 바뀐다.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lock_release</span> <span class="params">(<span class="keyword">struct</span> lock *lock)</span> &#123;</span><br><span class="line">    ASSERT (lock != <span class="literal">NULL</span>);</span><br><span class="line">    ASSERT (lock_held_by_current_thread (lock));</span><br><span class="line"></span><br><span class="line">    remove_with_lock(lock);</span><br><span class="line">    refresh_priority();</span><br><span class="line"></span><br><span class="line">    lock-&gt;holder = <span class="literal">NULL</span>;</span><br><span class="line">    sema_up (&amp;lock-&gt;semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">remove_with_lock</span><span class="params">(<span class="keyword">struct</span> lock *lock)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_elem</span> *<span class="title">e</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (e = list_begin(&amp;curr-&gt;donations); e != list_end(&amp;curr-&gt;donations); e = list_next(e)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span> =</span> list_entry(e, <span class="keyword">struct</span> thread, donation_elem);</span><br><span class="line">        <span class="keyword">if</span> (t-&gt;wait_on_lock == lock) </span><br><span class="line">            list_remove(&amp;t-&gt;donation_elem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">refresh_priority</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">curr</span> =</span> thread_current();</span><br><span class="line">    curr-&gt;priority = curr-&gt;init_priority;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!list_empty(&amp;curr-&gt;donations)) &#123;</span><br><span class="line">        list_sort(&amp;curr-&gt;donations, thread_compare_donate_priority, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">front</span> =</span> list_entry(list_front(&amp;curr-&gt;donations), <span class="keyword">struct</span> thread, donation_elem);</span><br><span class="line">        <span class="keyword">if</span> (front-&gt;priority &gt; curr-&gt;priority)</span><br><span class="line">            curr-&gt;priority = front-&gt;priority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://malgcheong.github.io/">Cheongwoo Nam</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://malgcheong.github.io/2024/05/02/pintos/1/">https://malgcheong.github.io/2024/05/02/pintos/1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SW-%EC%82%AC%EA%B4%80%ED%95%99%EA%B5%90-%EC%A0%95%EA%B8%80/">SW 사관학교 정글</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_linkedin"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/17/c/1/" title="C프로그램 메모리 관련 버그"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">C프로그램 메모리 관련 버그</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/14/pintos/2/" title="OS Project 2 WIL"><img class="cover" src="/images/pintos/part2%20user%20program.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">OS Project 2 WIL</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/03/16/%08%ED%9A%8C%EA%B3%A0/1/" title="SW 사관학교 정글 0주차 회고"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-16</div><div class="title">SW 사관학교 정글 0주차 회고</div></div></a></div><div><a href="/2024/05/31/Tip/1/" title="LeetHub 커스텀하기"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-31</div><div class="title">LeetHub 커스텀하기</div></div></a></div><div><a href="/2024/05/28/pintos/3/" title="OS Project 3 WIL-2"><img class="cover" src="/images/pintos/part3%20virtual%20memory.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-28</div><div class="title">OS Project 3 WIL-2</div></div></a></div><div><a href="/2024/05/21/pintos/4/" title="OS Project 3 WIL"><img class="cover" src="/images/pintos/part3%20virtual%20memory.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">OS Project 3 WIL</div></div></a></div><div><a href="/2024/05/14/pintos/2/" title="OS Project 2 WIL"><img class="cover" src="/images/pintos/part2%20user%20program.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">OS Project 2 WIL</div></div></a></div><div><a href="/2024/04/17/c/1/" title="C프로그램 메모리 관련 버그"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-17</div><div class="title">C프로그램 메모리 관련 버그</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Alarm-Clock"><span class="toc-text">1. Alarm Clock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#timer-interrupt"><span class="toc-text">timer interrupt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Problem"><span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solve"><span class="toc-text">Solve</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Priority-Scheduling"><span class="toc-text">2. Priority Scheduling</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Problem-1"><span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solve-1"><span class="toc-text">Solve</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Priority-Scheduling-priority-inversion"><span class="toc-text">3. Priority Scheduling - priority inversion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Problem-2"><span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solve-donation"><span class="toc-text">Solve (donation)</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/images/pintos/part1%20thread.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2024 By Cheongwoo Nam</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>